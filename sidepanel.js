let currentSelectedText=null,currentTabUrl=null,currentTabTitle=null;function escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function analyzeSelectedText(){if(currentSelectedText){document.getElementById("analysis-result").innerHTML='<div class="loading-spinner"><p>‚è≥ Se√ßili text analiz ediliyor...</p></div>';try{const e=await chrome.storage.sync.get(["aiProvider","aiApiKey"]);if(!e.aiProvider||!e.aiApiKey)return void showMessage("API ayarlarƒ±nƒ± popup √ºzerinden yapƒ±landƒ±rƒ±n.","error");const t=await new Promise(t=>{chrome.runtime.sendMessage({action:"analyzeSelectedText",selectedText:currentSelectedText,tabUrl:currentTabUrl,tabTitle:currentTabTitle,provider:e.aiProvider,apiKey:e.aiApiKey},t)});t.success?displayAnalysisResult(t.data):showMessage(`Hata: ${t.error||"Bilinmeyen hata"}`,"error")}catch(e){showMessage(`Hata: ${e.message}`,"error")}}else showMessage('L√ºtfen bir text se√ßin ve context menu\'den "Test Case/User Story Olu≈ütur" se√ßeneƒüini kullanƒ±n.',"info")}function displayAnalysisResult(e){const t=document.getElementById("analysis-result");let n='<div class="analysis-content">';e.analysis&&(n+=`<div class="analysis-section">\n      <h3>üìã Analiz</h3>\n      <p>${e.analysis.replace(/\n/g,"<br>")}</p>\n    </div>`),e.suggestions&&e.suggestions.length>0&&(n+='<div class="analysis-section">\n      <h3>üí° √ñneriler</h3>\n      <ul>',e.suggestions.forEach(e=>{n+=`<li>${escapeHtml(e)}</li>`}),n+="</ul></div>"),e.testCases&&e.testCases.length>0&&(n+='<div class="analysis-section">\n      <h3>‚úÖ √ñnerilen Test Case\'ler</h3>',e.testCases.forEach((e,t)=>{n+=`<div class="test-case-item">\n        <strong>${t+1}. ${escapeHtml(e.title||e)}</strong>\n      </div>`}),n+="</div>"),n+="</div>",t.innerHTML=n}function showAnalysisPanel(){const e=document.getElementById("history");if(!document.getElementById("analysis-result")){const e=document.querySelector(".panel-content")||document.body,t=document.createElement("div");t.id="analysis-result",t.className="analysis-panel",e.appendChild(t)}e&&(e.style.display="none"),document.getElementById("analysis-result").style.display="block"}function showHistoryPanel(){const e=document.getElementById("history"),t=document.getElementById("analysis-result");e&&(e.style.display="block"),t&&(t.style.display="none"),currentSelectedText=null}function showMessage(e,t="info"){document.getElementById("analysis-result").innerHTML=`<div class="message message-${t}">${e}</div>`}function escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}chrome.runtime.onMessage.addListener((e,t,n)=>{"selectedTextReceived"===e.action&&(currentSelectedText=e.selectedText,currentTabUrl=e.tabUrl,currentTabTitle=e.tabTitle,showAnalysisPanel(),analyzeSelectedText())}),document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("history");try{const t=await new Promise(e=>{chrome.runtime.sendMessage({action:"getHistory"},e)});if(t.success){if(0===t.data.length)return void(e.innerHTML='\n          <div class="empty-state">\n            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>\n            </svg>\n            <p>Hen√ºz analiz yapƒ±lmamƒ±≈ü.</p>\n            <p style="font-size: 12px; margin-top: 8px;">Herhangi bir sayfada text se√ßip context menu\'den "Test Case/User Story Olu≈ütur" se√ßeneƒüini kullanƒ±n.</p>\n          </div>\n        ');e.innerHTML=t.data.map(e=>{const t=new Date(e.timestamp).toLocaleString("tr-TR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return`\n          <div class="history-item" onclick="window.open('${e.url}', '_blank')">\n            <h3>${escapeHtml(e.title||"Ba≈ülƒ±ksƒ±z")}</h3>\n            <div class="date">${t}</div>\n            <a href="${e.url}" class="url" target="_blank" onclick="event.stopPropagation()">${e.url}</a>\n          </div>\n        `}).join("")}else e.innerHTML=`\n        <div class="empty-state">\n          <p style="color: #721c24;">Hata: ${t.error||"Bilinmeyen hata"}</p>\n        </div>\n      `}catch(t){e.innerHTML=`\n      <div class="empty-state">\n        <p style="color: #721c24;">Hata: ${t.message}</p>\n      </div>\n    `}});