const providerInfo={groq:{name:"Groq",description:"HÄ±zlÄ± ve Ã¼cretsiz. API key almak iÃ§in:",link:"https://console.groq.com/keys",placeholder:"gsk_...",free:!0},huggingface:{name:"Hugging Face",description:"Ãœcretsiz inference API. Token almak iÃ§in:",link:"https://huggingface.co/settings/tokens",placeholder:"hf_...",free:!0},gemini:{name:"Google Gemini",description:"Ãœcretsiz tier mevcut. API key almak iÃ§in:",link:"https://makersuite.google.com/app/apikey",placeholder:"AIza...",free:!0},together:{name:"Together AI",description:"Ãœcretsiz tier mevcut. API key almak iÃ§in:",link:"https://api.together.xyz/settings/api-keys",placeholder:"...",free:!0},openai:{name:"OpenAI",description:"Ãœcretli servis. API key almak iÃ§in:",link:"https://platform.openai.com/api-keys",placeholder:"sk-...",free:!1},ollama:{name:"Ollama",description:"Local kullanÄ±m iÃ§in. Ollama kurulu olmalÄ±. Endpoint:",link:"https://ollama.ai",placeholder:"http://localhost:11434",free:!0,isLocal:!0}};document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("aiProvider"),t=document.getElementById("apiKey"),n=document.getElementById("providerInfo"),a=await chrome.storage.sync.get(["aiProvider","aiApiKey"]);a.aiProvider&&(e.value=a.aiProvider),a.aiApiKey&&(t.value=a.aiApiKey);let s=null;const i=async()=>{s&&clearTimeout(s),s=setTimeout(async()=>{const n=e.value,a=t.value.trim();if(a)try{const e={};n&&(e.aiProvider=n),a&&(e.aiApiKey=a),await chrome.storage.sync.set(e),console.log("Test-San Assistant: Otomatik kaydedildi")}catch(e){console.error("Test-San Assistant: Otomatik kaydetme hatasÄ±",e)}},1e3)};function o(){const a=e.value,s=providerInfo[a];n.innerHTML=`\n      <strong>${s.name}</strong><br>\n      ${s.description}<br>\n      <a href="${s.link}" target="_blank">${s.link}</a>\n      ${s.free?'<br><span style="color: green;">âœ“ Ãœcretsiz</span>':""}\n      ${s.isLocal?'<br><span style="color: orange;">âš  Local kullanÄ±m</span>':""}\n    `,t.placeholder=s.placeholder,t.type=s.isLocal?"text":"password"}t.addEventListener("input",i),e.addEventListener("change",i),t.addEventListener("blur",async()=>{s&&clearTimeout(s);const e=t.value.trim();if(e)try{await chrome.storage.sync.set({aiApiKey:e}),console.log("Test-San Assistant: API key kaydedildi");const t=document.getElementById("status");t.className="status success",t.textContent="âœ“ API key kaydedildi",setTimeout(()=>{"âœ“ API key kaydedildi"===t.textContent&&(t.textContent="")},2e3)}catch(e){console.error("Test-San Assistant: API key kaydetme hatasÄ±",e)}}),e.addEventListener("change",o),o(),document.getElementById("saveBtn").addEventListener("click",async n=>{n.preventDefault(),n.stopPropagation(),s&&(clearTimeout(s),s=null);const a=e.value,i=t.value.trim(),o=document.getElementById("status"),r=document.getElementById("saveBtn");if(r.disabled=!0,r.textContent="Kaydediliyor...",!i)return o.className="status error",o.textContent="LÃ¼tfen API key girin",r.disabled=!1,void(r.textContent="Kaydet");try{await chrome.storage.sync.set({aiProvider:a,aiApiKey:i});const e=await chrome.storage.sync.get(["aiApiKey","aiProvider"]);if(!e.aiApiKey||e.aiApiKey!==i)throw new Error("API key kaydedilemedi. LÃ¼tfen tekrar deneyin.");o.className="status success",o.textContent="âœ“ Ayarlar kaydedildi!",r.disabled=!1,r.textContent="Kaydet"}catch(e){o.className="status error",o.textContent="Hata: "+e.message,r.disabled=!1,r.textContent="Kaydet"}}),window.addEventListener("beforeunload",async()=>{s&&clearTimeout(s);const n=t.value.trim(),a=e.value;if(n)try{const e={};a&&(e.aiProvider=a),n&&(e.aiApiKey=n),await chrome.storage.sync.set(e)}catch(e){console.error("Test-San Assistant: beforeunload kaydetme hatasÄ±",e)}});const r=document.getElementById("analyzeTestCaseBtn"),l=document.getElementById("createTestPlanBtn"),c=document.getElementById("analysisStatus"),d=document.getElementById("analysisResults");async function u(){const e=!!(await chrome.storage.sync.get(["aiApiKey"])).aiApiKey;r&&(r.disabled=!e,e||(r.title="Ã–nce API key girin")),l&&(l.disabled=!e,e||(l.title="Ã–nce API key girin"))}function y(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}u(),t.addEventListener("input",()=>{setTimeout(u,100)}),r?r.addEventListener("click",async()=>{if(console.log("Test-San Assistant: Test Case analiz butonu tÄ±klandÄ±"),!(await chrome.storage.sync.get(["aiApiKey"])).aiApiKey)return c.style.display="block",c.className="status error",void(c.textContent="LÃ¼tfen Ã¶nce API key girin ve kaydedin");r.disabled=!0,r.textContent="Analiz ediliyor...",c.style.display="block",c.className="status info",c.textContent="Sayfa iÃ§eriÄŸi alÄ±nÄ±yor...",d.style.display="none";try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||!e.id)throw new Error("Aktif tab bulunamadÄ±");const t=(await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>{const e=document.querySelector(".work-item-form-body")||document.querySelector(".work-item-view")||document.querySelector('[role="main"]')||document.querySelector(".bolt-page-content")||document.body;return{title:document.title,url:window.location.href,text:e?e.innerText||e.textContent:document.body.innerText}}}))[0].result;c.textContent="AI analiz ediyor...";const n=await chrome.runtime.sendMessage({action:"analyzeTestCase",title:t.title,content:t.text,url:t.url});if(!n||!n.success)throw new Error(n?.error||"Analiz baÅŸarÄ±sÄ±z");c.className="status success",c.textContent="âœ“ Analiz tamamlandÄ±!",d.style.display="block",d.innerHTML=`\n          <h4>ğŸ“Š Analiz SonuÃ§larÄ±</h4>\n          <p><strong>Analiz:</strong> ${y(n.data.analysis||"N/A")}</p>\n          <h4>ğŸ’¡ CÃ¼mle Ã–nerileri</h4>\n          <ul>\n            ${(n.data.sentenceSuggestions||[]).map(e=>`<li>${y(e)}</li>`).join("")}\n          </ul>\n          <h4>â• Ekstra Test Case Ã–nerileri</h4>\n          <ul>\n            ${(n.data.additionalTestCases||[]).map(e=>`<li>${y(e)}</li>`).join("")}\n          </ul>\n          <h4>â­ Kalite Skoru</h4>\n          <p>${y(n.data.qualityScore||"N/A")}</p>\n        `}catch(e){c.className="status error",c.textContent="Hata: "+e.message,console.error("Test Case analiz hatasÄ±:",e)}finally{r.disabled=!1,r.textContent="ğŸ“‹ Test Case Analiz Et"}}):console.error("Test-San Assistant: analyzeTestCaseBtn bulunamadÄ±"),l?l.addEventListener("click",async()=>{if(console.log("Test-San Assistant: Test Plan oluÅŸtur butonu tÄ±klandÄ±"),!(await chrome.storage.sync.get(["aiApiKey"])).aiApiKey)return c.style.display="block",c.className="status error",void(c.textContent="LÃ¼tfen Ã¶nce API key girin ve kaydedin");l.disabled=!0,l.textContent="Test planÄ± oluÅŸturuluyor...",c.style.display="block",c.className="status info",c.textContent="Sayfa iÃ§eriÄŸi alÄ±nÄ±yor...",d.style.display="none";try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||!e.id)throw new Error("Aktif tab bulunamadÄ±");const t=(await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>{const e=document.querySelector(".work-item-form-body")||document.querySelector(".work-item-view")||document.querySelector('[role="main"]')||document.querySelector(".bolt-page-content")||document.body;return{title:document.title,url:window.location.href,text:e?e.innerText||e.textContent:document.body.innerText}}}))[0].result;c.textContent="AI test planÄ± oluÅŸturuyor...";const n=await chrome.runtime.sendMessage({action:"createTestPlan",title:t.title,content:t.text,url:t.url});if(!n||!n.success)throw new Error(n?.error||"Test planÄ± oluÅŸturulamadÄ±");c.className="status success",c.textContent="âœ“ Test planÄ± oluÅŸturuldu!",d.style.display="block",d.innerHTML=`\n          <h4>ğŸ“‹ Test PlanÄ± Genel BakÄ±ÅŸ</h4>\n          <p>${y(n.data.testPlanOverview||"N/A")}</p>\n          <h4>ğŸ§ª Test Case'ler</h4>\n          ${(n.data.testCases||[]).map((e,t)=>`\n            <div style="background: white; padding: 12px; margin: 8px 0; border-radius: 4px; border-left: 4px solid #667eea;">\n              <strong>${t+1}. ${y(e.title||"Test Case "+(t+1))}</strong>\n              <p style="margin: 4px 0;"><em>${y(e.description||"N/A")}</em></p>\n              <p style="margin: 4px 0; font-size: 11px; color: #666;">Tip: ${y(e.testType||"functional")}</p>\n              <div style="margin-top: 8px;">\n                <strong style="font-size: 12px;">Test AdÄ±mlarÄ±:</strong>\n                <ol style="margin: 4px 0; padding-left: 20px; font-size: 12px;">\n                  ${(e.testSteps||[]).map(e=>`\n                    <li style="margin: 2px 0;">\n                      <strong>AdÄ±m ${e.step||"N/A"}:</strong> ${y(e.action||"N/A")}\n                      <br><em style="color: #666;">Beklenen: ${y(e.expectedResult||"N/A")}</em>\n                    </li>\n                  `).join("")}\n                </ol>\n              </div>\n            </div>\n          `).join("")}\n        `}catch(e){c.className="status error",c.textContent="Hata: "+e.message,console.error("Test planÄ± oluÅŸturma hatasÄ±:",e)}finally{l.disabled=!1,l.textContent="ğŸ“ User Storyâ€™den Test PlanÄ± OluÅŸtur"}}):console.error("Test-San Assistant: createTestPlanBtn bulunamadÄ±")});