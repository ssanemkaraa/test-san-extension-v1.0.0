chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"analyze-selected-text",title:"Test Case/User Story Oluştur (Seçili Text)",contexts:["selection"]})}),chrome.contextMenus.onClicked.addListener((e,t)=>{"analyze-selected-text"===e.menuItemId&&e.selectionText&&chrome.sidePanel.open({tabId:t.id,windowId:t.windowId},()=>{chrome.runtime.sendMessage({action:"selectedTextReceived",selectedText:e.selectionText,tabUrl:t.url,tabTitle:t.title}).catch(e=>{console.log("Side panel henüz açılmıyor, mesaj sonra gönderilecek")})})});const AI_PROVIDERS={groq:{name:"Groq",url:"https://api.groq.com/openai/v1/chat/completions",defaultModel:"llama-3.3-70b-versatile",headers:e=>({"Content-Type":"application/json",Authorization:`Bearer ${e}`})},huggingface:{name:"Hugging Face",url:"https://api-inference.huggingface.co/models/meta-llama/Meta-Llama-3-8B-Instruct",defaultModel:"meta-llama/Meta-Llama-3-8B-Instruct",headers:e=>({"Content-Type":"application/json",Authorization:`Bearer ${e}`}),customFormat:!0},gemini:{name:"Google Gemini",url:e=>`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${e}`,defaultModel:"gemini-pro",headers:()=>({"Content-Type":"application/json"}),customFormat:!0},together:{name:"Together AI",url:"https://api.together.xyz/v1/chat/completions",defaultModel:"meta-llama/Llama-3-8b-chat-hf",headers:e=>({"Content-Type":"application/json",Authorization:`Bearer ${e}`})},openai:{name:"OpenAI",url:"https://api.openai.com/v1/chat/completions",defaultModel:"gpt-4",headers:e=>({"Content-Type":"application/json",Authorization:`Bearer ${e}`})},ollama:{name:"Ollama",url:e=>`${e}/api/chat`,defaultModel:"llama3",headers:()=>({"Content-Type":"application/json"}),customFormat:!0,isLocal:!0}};let db;function initDB(){return new Promise((e,t)=>{const n=indexedDB.open("QAAssistantDB",1);n.onerror=()=>t(n.error),n.onsuccess=()=>{db=n.result,e(db)},n.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("testCases")){const e=t.createObjectStore("testCases",{keyPath:"id",autoIncrement:!0});e.createIndex("url","url",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}if(!t.objectStoreNames.contains("userStories")){const e=t.createObjectStore("userStories",{keyPath:"id",autoIncrement:!0});e.createIndex("url","url",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}t.objectStoreNames.contains("learnedData")||t.createObjectStore("learnedData",{keyPath:"id",autoIncrement:!0})}})}async function saveTestCase(e){return db||await initDB(),new Promise((t,n)=>{const a=db.transaction(["testCases"],"readwrite").objectStore("testCases").add({url:e.url,title:e.title,content:e.content,analysis:e.analysis,suggestions:e.suggestions,timestamp:Date.now()});a.onsuccess=()=>t(a.result),a.onerror=()=>n(a.error)})}async function saveUserStory(e){return db||await initDB(),new Promise((t,n)=>{const a=db.transaction(["userStories"],"readwrite").objectStore("userStories").add({url:e.url,title:e.title,content:e.content,testPlan:e.testPlan,timestamp:Date.now()});a.onsuccess=()=>t(a.result),a.onerror=()=>n(a.error)})}async function getTestCases(e=10){return db||await initDB(),new Promise((t,n)=>{const a=db.transaction(["testCases"],"readonly").objectStore("testCases").index("timestamp").openCursor(null,"prev"),s=[];let r=0;a.onsuccess=n=>{const a=n.target.result;a&&r<e?(s.push(a.value),r++,a.continue()):t(s)},a.onerror=()=>n(a.error)})}function formatMessagesForProvider(e,t){const n=AI_PROVIDERS[e];return n.customFormat?"huggingface"===e?t.map(e=>"system"===e.role?`<|system|>\n${e.content}<|end|>\n`:"user"===e.role?`<|user|>\n${e.content}<|end|>\n`:"assistant"===e.role?`<|assistant|>\n${e.content}<|end|>\n`:void 0).join("")+"<|assistant|>\n":"gemini"===e?{contents:t.filter(e=>"system"!==e.role).map(e=>({role:"assistant"===e.role?"model":"user",parts:[{text:e.content}]}))}:"ollama"===e?{model:n.defaultModel,messages:t,stream:!1}:t:t}function parseProviderResponse(e,t){return"gemini"===e?t.candidates[0].content.parts[0].text:"huggingface"===e?t[0].generated_text:"ollama"===e?t.message.content:t.choices[0].message.content}async function callAI(e,t="groq"){const n=await chrome.storage.sync.get(["aiProvider","aiApiKey"]),a=n.aiProvider||t,s=n.aiApiKey;if(!s)throw new Error("API key bulunamadı. Lütfen popup'tan API key'inizi girin.");const r=AI_PROVIDERS[a];if(!r)throw new Error(`Bilinmeyen provider: ${a}`);let i;i="function"==typeof r.url?r.url(s):r.url;const o=r.headers(s);let l;if("gemini"===a)l=formatMessagesForProvider(a,e);else if("huggingface"===a){const t=formatMessagesForProvider(a,e);l=JSON.stringify({inputs:t,parameters:{max_new_tokens:2e3,temperature:.7,return_full_text:!1}})}else l="ollama"===a?JSON.stringify(formatMessagesForProvider(a,e)):JSON.stringify({model:r.defaultModel,messages:e,temperature:.7});try{const e=await fetch(i,{method:"POST",headers:o,body:l});if(!e.ok){const t=await e.text();throw new Error(`API hatası (${e.status}): ${t}`)}return parseProviderResponse(a,await e.json())}catch(e){if("ollama"===a&&e.message.includes("Failed to fetch"))throw new Error("Ollama bağlantı hatası. Ollama'nın çalıştığından emin olun: ollama serve");throw e}}async function analyzeTestCase(e,t){const n=[{role:"system",content:"Sen bir QA mühendisi asistanısın. Test case'leri analiz edip, iyileştirme önerileri sunuyorsun. \n      Geçmiş test case'lerden öğrendiklerini kullanarak daha iyi öneriler veriyorsun. \n      Türkçe yanıt ver."},{role:"user",content:`Aşağıdaki test case'i analiz et ve yorumla. Geçmiş test case'lerden öğrendiklerini de kullan:\n      \nGeçmiş Test Case'ler:\n${(await getTestCases(5)).map(e=>`Test Case: ${e.title}\n${e.content}`).join("\n\n---\n\n")||"Henüz geçmiş test case yok."}\n\nYeni Test Case:\n${e}\n\nLütfen şunları sağla:\n1. Test case'in detaylı analizi ve yorumu\n2. Daha iyi cümleler için öneriler\n3. Eksik olabilecek ekstra test case'ler için öneriler\n4. Test case'in kalitesi hakkında değerlendirme\n\nJSON formatında döndür (sadece JSON, başka metin ekleme):\n{\n  "analysis": "...",\n  "sentenceSuggestions": ["...", "..."],\n  "additionalTestCases": ["...", "..."],\n  "qualityScore": "..."\n}`}],a=await callAI(n);try{const e=a.match(/\{[\s\S]*\}/);return e?JSON.parse(e[0]):JSON.parse(a)}catch(e){return{analysis:a,sentenceSuggestions:[],additionalTestCases:[],qualityScore:"Analiz tamamlandı"}}}async function createTestPlan(e,t){const n=[{role:"system",content:"Sen bir QA mühendisi asistanısın. User story'lerden kapsamlı test planları oluşturuyorsun. \n      Geçmiş test case'lerden öğrendiklerini kullanarak tutarlı ve kaliteli test planları hazırlıyorsun.\n      Türkçe yanıt ver."},{role:"user",content:`Aşağıdaki user story için detaylı bir test planı oluştur. Geçmiş test case'lerden öğrendiklerini de kullan:\n      \nGeçmiş Test Case'ler (referans için):\n${(await getTestCases(10)).map(e=>`Test Case: ${e.title}\n${e.content}`).join("\n\n---\n\n")||"Henüz geçmiş test case yok."}\n\nUser Story:\n${e}\n\nLütfen şunları içeren kapsamlı bir test planı oluştur:\n1. Test planı genel bakışı\n2. Test case'ler (her biri için):\n   - Test case başlığı\n   - Test case açıklaması\n   - Test adımları (detaylı)\n   - Beklenen sonuçlar\n   - Test tipi (functional, regression, integration, vb.)\n\nJSON formatında döndür (sadece JSON, başka metin ekleme):\n{\n  "testPlanOverview": "...",\n  "testCases": [\n    {\n      "title": "...",\n      "description": "...",\n      "testSteps": [\n        {\n          "step": 1,\n          "action": "...",\n          "expectedResult": "..."\n        }\n      ],\n      "testType": "..."\n    }\n  ]\n}`}],a=await callAI(n);try{const e=a.match(/\{[\s\S]*\}/);return e?JSON.parse(e[0]):JSON.parse(a)}catch(e){return{testPlanOverview:a,testCases:[{title:"Test Case 1",description:a.substring(0,200),testSteps:[],testType:"functional"}]}}}chrome.runtime.onMessage.addListener((e,t,n)=>((async()=>{try{if("analyzeTestCase"===e.action){const t=await analyzeTestCase(e.content,e.url);await saveTestCase({url:e.url,title:e.title,content:e.content,analysis:t.analysis,suggestions:{sentences:t.sentenceSuggestions,additionalCases:t.additionalTestCases}}),n({success:!0,data:t})}else if("createTestPlan"===e.action){const t=await createTestPlan(e.content,e.url);await saveUserStory({url:e.url,title:e.title,content:e.content,testPlan:t}),n({success:!0,data:t})}else if("analyzeSelectedText"===e.action){let t;const a=e.selectedText.substring(0,1e3),s=a.toLowerCase();t=s.includes("test")||s.includes("expected")||s.includes("step")?await analyzeTestCase(a,e.tabUrl):await createTestPlan(a,e.tabUrl),await saveTestCase({url:e.tabUrl,title:e.tabTitle||"Seçili Text Analiz",content:a,analysis:t.analysis||t.testPlanOverview,suggestions:{sentences:t.sentenceSuggestions||[],additionalCases:t.testCases||[]}}),n({success:!0,data:t})}else if("getHistory"===e.action){const e=await getTestCases(20);n({success:!0,data:e})}}catch(e){n({success:!1,error:e.message})}})(),!0)),initDB();