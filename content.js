function detectPageType(){const e=window.location.href.toLowerCase(),t=document.title.toLowerCase(),n=document.body.innerText?.toLowerCase()||"";return e.includes("/test")||e.includes("testcase")||e.includes("_testmanagement")||e.includes("test-plan")||t.includes("test case")||n.includes("test case")||document.querySelector('[data-testid*="test"]')||document.querySelector('[aria-label*="Test Case"]')||document.querySelector('[aria-label*="test case"]')?"testCase":e.includes("/workitems")||e.includes("userstory")||e.includes("user-story")||t.includes("user story")||n.includes("user story")||document.querySelector('[aria-label*="User Story"]')||document.querySelector('[aria-label*="user story"]')||document.querySelector(".work-item-form-header")?.textContent?.toLowerCase().includes("user story")||e.includes("dev.azure.com")&&(e.includes("/_workitems")||e.includes("/_backlogs"))||e.includes("dev.azure.com")||e.includes("visualstudio.com")?"userStory":"unknown"}function extractTestCaseContent(){const e={title:document.title,url:window.location.href,text:""},t=document.querySelector(".work-item-form-body")||document.querySelector(".work-item-view")||document.querySelector('[role="main"]')||document.querySelector(".bolt-page-content");return e.text=t?t.innerText||t.textContent:document.body.innerText||document.body.textContent,e}function extractUserStoryContent(){const e={title:document.title,url:window.location.href,text:""},t=document.querySelector(".work-item-form-body")||document.querySelector(".work-item-view")||document.querySelector('[role="main"]')||document.querySelector(".bolt-page-content");return e.text=t?t.innerText||t.textContent:document.body.innerText||document.body.textContent,e}function addAnalysisButton(e){if(document.getElementById("qa-ai-assistant-btn"))return;const t=document.createElement("button");t.id="qa-ai-assistant-btn",t.className="qa-ai-button",t.innerHTML='\n    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n      <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>\n    </svg>\n    <span>AI Analiz</span>\n  ',t.addEventListener("click",async()=>{t.disabled=!0,t.innerHTML="<span>Analiz ediliyor...</span>";try{let t,n;const s=detectPageType(),o="unknown"!==s?s:e;if("testCase"===o)t=extractTestCaseContent(),n="analyzeTestCase";else{if("userStory"!==o&&"unknown"!==o)throw new Error("Sayfa tipi tanÄ±namadÄ±");t=extractUserStoryContent(),n="createTestPlan"}const a=await chrome.runtime.sendMessage({action:n,title:t.title,content:t.text,url:t.url});if(!a||!a.success)throw new Error(a?.error||"Bilinmeyen hata");showResults(a.data,o)}catch(e){alert("Hata: "+e.message),console.error("Test-San Assistant Error:",e)}finally{t.disabled=!1,t.innerHTML='\n        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>\n        </svg>\n        <span>AI Analiz</span>\n      '}});let n=!1;const s=[".work-item-form-header",".work-item-header",".bolt-header-title",".ms-CommandBar",".command-bar",'[aria-label*="Title"]',".work-item-form-title",".work-item-title","header",".page-header",".page-title"];for(const e of s){const s=document.querySelector(e);if(s){const e=document.createElement("div");e.style.display="inline-flex",e.style.marginLeft="10px",e.style.alignItems="center",e.appendChild(t),s.appendChild(e),n=!0;break}}return n||(t.style.position="fixed",t.style.top="80px",t.style.right="20px",t.style.zIndex="999999",document.body.appendChild(t),n=!0),n&&console.log("Test-San Assistant: Buton eklendi, sayfa tipi:",e),n}function showResults(e,t){const n=document.getElementById("qa-ai-results-panel");n&&n.remove();const s=document.createElement("div");s.id="qa-ai-results-panel",s.className="qa-ai-results-panel","testCase"===t?s.innerHTML=`\n      <div class="qa-ai-panel-header">\n        <h3>AI Analiz SonuÃ§larÄ±</h3>\n        <button class="qa-ai-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>\n      </div>\n      <div class="qa-ai-panel-content">\n        <section>\n          <h4>Analiz</h4>\n          <p>${escapeHtml(e.analysis||"Analiz bulunamadÄ±")}</p>\n        </section>\n        <section>\n          <h4>CÃ¼mle Ã–nerileri</h4>\n          <ul>\n            ${(e.sentenceSuggestions||[]).map(e=>`<li>${escapeHtml(e)}</li>`).join("")}\n          </ul>\n        </section>\n        <section>\n          <h4>Ekstra Test Case Ã–nerileri</h4>\n          <ul>\n            ${(e.additionalTestCases||[]).map(e=>`<li>${escapeHtml(e)}</li>`).join("")}\n          </ul>\n        </section>\n        <section>\n          <h4>Kalite Skoru</h4>\n          <p>${escapeHtml(e.qualityScore||"N/A")}</p>\n        </section>\n      </div>\n    `:"userStory"===t&&(s.innerHTML=`\n      <div class="qa-ai-panel-header">\n        <h3>Test PlanÄ±</h3>\n        <button class="qa-ai-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>\n      </div>\n      <div class="qa-ai-panel-content">\n        <section>\n          <h4>Test PlanÄ± Genel BakÄ±ÅŸ</h4>\n          <p>${escapeHtml(e.testPlanOverview||"N/A")}</p>\n        </section>\n        <section>\n          <h4>Test Case'ler</h4>\n          ${(e.testCases||[]).map((e,t)=>`\n            <div class="test-case-card">\n              <h5>${t+1}. ${escapeHtml(e.title||"Test Case "+(t+1))}</h5>\n              <p><strong>AÃ§Ä±klama:</strong> ${escapeHtml(e.description||"N/A")}</p>\n              <p><strong>Test Tipi:</strong> ${escapeHtml(e.testType||"functional")}</p>\n              <div class="test-steps">\n                <strong>Test AdÄ±mlarÄ±:</strong>\n                <ol>\n                  ${(e.testSteps||[]).map(e=>`\n                    <li>\n                      <strong>AdÄ±m ${e.step||"N/A"}:</strong> ${escapeHtml(e.action||"N/A")}\n                      <br><em>Beklenen SonuÃ§:</em> ${escapeHtml(e.expectedResult||"N/A")}\n                    </li>\n                  `).join("")}\n                </ol>\n              </div>\n            </div>\n          `).join("")}\n        </section>\n      </div>\n    `),document.body.appendChild(s)}function escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}console.log("%cðŸ”µ Test-San Assistant: Content script YÃœKLENDÄ°!","color: #667eea; font-weight: bold; font-size: 16px; background: #f0f0f0; padding: 5px;"),console.log("Test-San Assistant: Script baÅŸlatÄ±lÄ±yor...",(new Date).toISOString()),console.log("%cðŸ”µ Test-San Assistant: Content script YÃœKLENDÄ°!","color: #667eea; font-weight: bold; font-size: 16px; background: #f0f0f0; padding: 5px;"),console.log("Test-San Assistant: URL:",window.location.href),chrome.runtime.onMessage.addListener((e,t,n)=>("addButton"===e.action&&(function(){if(document.getElementById("qa-ai-assistant-btn"))return void console.log("Test-San Assistant: Buton zaten mevcut");const e=detectPageType();console.log("Test-San Assistant: Sayfa tipi:",e),addAnalysisButton(e)}(),n({success:!0})),!0)),console.log('Test-San Assistant: Content script hazÄ±r. Buton eklemek iÃ§in popup\'tan "Kaydet" butonuna basÄ±n.');